# 交易所行情与撮合

## 1. 交易所L2行情

这里所指的L2行情为A股交易所（深交所、上交所）在交易所本地机房发布的L2行情（或称非展示行情），而非券商或互联网服务商提供的L2行情（展示行情）。

### 1.1 交易所L2行情接口协议

常用的深交所L2行情协议为Binary格式，当前最新版本号1.12；常用的上交所L2行情为STEP嵌套FAST格式，当前版本号2.0.6。行情接口协议文档均可在交易所网站下载：

[深交所L2行情协议](https://www.szse.cn/marketServices/technicalservice/interface/P020220523530959450444.pdf)

[上交所L2行情协议](https://www.sseinfo.com/services/assortment/document/interface/c/5702218.pdf)

### 1.2 L2行情消息分类

交易所发出的L2行情中包含的消息类型很多，包括管理消息、公共消息、市场状态、公告和实时行情消息，其中实时行情消息又包括快照行情（snap）和逐笔行情，后者又分为逐笔委托行情（order）和逐笔成交行情（execution）。

在进行订单簿重建时我们使用的是逐笔行情，同时利用快照行情对重建的订单簿进行校验。

虽然上交所和深交所的L2行情接口不同，但实时行情消息的有效字段大体一致，具体参见[L2行情消息细节](/doc/msgTypes.md)

### 1.3 行情带宽

交易所L2行情采用万兆光纤接入，带宽要求约25Mbps，若需要主备行情源，则需要两路万兆物理口。

本设计不支持主备切换（输入数据应已完成主备切换或选优）。

---

## 2. 撮合原理

交易所的撮合遵循“价格优先，时间优先”的原则。

* 限价单撮合

    在连续交易期间，当有新限价单到达时，先判断是否对手方有可成交价格，再从对方最优价格的订单队列中按照下单时间先后与之撮合（成交价为对方价格），若最优价格档位全部撮合完本方仍有余量，则继续判断是否有下一档可成交价格，以此类推。待无对手方可成交后，将剩余订单加入本方价格档订单队列之尾。

    在开盘或收盘集合竞价期间，先按照价格优先进行买卖匹配，成交价格取决于双方可成交的最大数量，待到集合竞价结束时刻按照双方下单时间顺序逐个成交。

* 市价单撮合

  市价申报只适用于有价格涨跌幅限制证券连续竞价期间的交易。
  深交所市价委托有五种方式：

  * 对手方最优价格申报：买入时以“卖一”为限价，卖出时以“买一”为限价。
  * 本方最优价格申报：以申报进入交易主机时集中申报簿中本方队列的最优价格为其申报价格。
  * 最优五档即时成交剩余撤销申报：依次以“买一”到“买五”价格作为卖出价格或依次以“卖一”到“卖五”价格作为买入价格，同时如申报无法全部成交，不能成交部分自动撤单。
  * 即时成交剩余撤销申报：与最优五档即时成交剩余撤销申报的区别在于本方式是与对手方所有申报成交。
  * 全额成交或撤销申报：以对手方价格为成交价格，如与申报进入交易主机时集中申报簿中对手方的所有申报队列依次成交能够使其完全成交的，则依次成交，否则申报全部自动撤销。

  但这五种市价委托在深交所逐笔委托中只分为市价或本方最优，无法区分对手市价单种类，只能根据对应的逐笔成交来确认，因此收到市价委托时不能直接判断出撮合结果，需等待成交到来。

### 2.1 创业板价格笼子

* 基准价格

    按```对手方一档价格 -> 本方一档价格 -> 最近成交价 -> 前收盘价``` 顺序做基准价，仅当前者不存在时取下一个。

* 价格笼子

    基准价的102%为上限，基准价的98%为下限

当创业板委托价格大于价格笼子上限或小于下限时，不进行撮合，而是缓存在交易所主机；待基准价格变动使其进入笼子范围后自动参与撮合。
